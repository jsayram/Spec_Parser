# Data Output Structure

This document describes all output files generated by the spec-parser pipeline.

## Output Location

All outputs are written to `data/` in the project root.

---

## Global Files (Append Across Devices)

These files accumulate data as you onboard more devices.

### `device_registry.json`
**Purpose:** Central database tracking all onboarded devices and their version history.

**Behavior:** 
- New device → Adds new top-level entry
- Same device, new version → Appends to `spec_history` array
- Same device, same version → Updates existing entry

**Contents:**
```json
{
  "Device_Name": {
    "vendor": "Vendor Name",
    "model": "Model Name", 
    "current_version": "1.0",
    "spec_history": [
      {
        "version": "1.0",
        "pdf_hash": "sha256...",
        "index_path": "timestamp_device/index",
        "report_path": "timestamp_device/reports/BASELINE_v1.0_*.md",
        "is_baseline": true,
        "message_summary": { ... },
        "unrecognized_messages": [ ... ]
      }
    ]
  }
}
```

---

### `custom_messages.json`
**Purpose:** Stores vendor-specific POCT1-A messages discovered during extraction, with full provenance.

**Behavior:**
- New device → Adds new top-level key with vendor messages
- Same device → Adds new messages, preserves existing ones
- Messages stay `"review_status": "pending"` until explicitly approved/rejected

**Contents:**
```json
{
  "Device_Name": {
    "MSG.ID": {
      "category": "vendor_specific",
      "citations": [
        {
          "page": 10,
          "bbox": [x1, y1, x2, y2],
          "source": "text",
          "citation_id": "p10_txt6"
        }
      ],
      "auto_accepted": true,
      "review_status": "pending",
      "notes": "Auto-accepted during spec parsing - Direction: →Host"
    }
  }
}
```

**Review Command:**
```bash
spec-parser device review-message --device-type <name> --message <id> --action approve|reject|defer --notes "..."
```

---

### `PENDING_REVIEW_*.md`
**Purpose:** Human-readable review queue listing all unrecognized messages pending coordinator review.

**Behavior:**
- Each extraction creates a **new** timestamped file
- Old files remain for audit trail
- Consolidates pending items across ALL devices

**Example Filename:** `PENDING_REVIEW_20260118_233742.md`

---

## Per-Device Session Directories

Located in `data/spec_output/<timestamp>_<device>/`

### Directory Structure
```
20260118_233729_quidelsofia/
├── images/           # Extracted images from PDF
│   ├── page5_img1.png
│   └── page8_img2.png
├── index/            # Search indexes
│   ├── faiss.faiss           # Vector embeddings (384-dim)
│   ├── faiss.metadata.json   # Block metadata for vector search
│   ├── bm25.bm25.pkl         # Keyword search index
│   └── bm25_metadata.json    # Block metadata for BM25
├── json/             # Machine-readable extraction
│   └── document.json         # Full structured extraction with citations
├── markdown/         # Human-readable output
│   └── full_document.md      # Merged markdown with tables/images
└── reports/          # Compliance/diff reports
    └── BASELINE_v1.0_*.md    # Initial baseline report
```

### File Details

| File | Purpose | Format |
|------|---------|--------|
| `images/*.png` | Extracted pictures/diagrams from PDF | PNG (300 DPI) |
| `faiss.faiss` | FAISS vector index for semantic search | Binary |
| `faiss.metadata.json` | Maps vector IDs to page/block/citation | JSON |
| `bm25.bm25.pkl` | BM25 keyword search index | Pickle |
| `bm25_metadata.json` | Maps BM25 doc IDs to page/block/citation | JSON |
| `document.json` | Full extraction: pages, blocks, citations, OCR | JSON |
| `full_document.md` | Readable markdown with tables and image refs | Markdown |
| `BASELINE_*.md` | Initial spec baseline report | Markdown |
| `CHANGE_*.md` | Diff report when updating versions | Markdown |

---

## Input Specifications

Located in `data/specs/`

### Directory Structure
```
specs/
├── poct1a_specs/     # POCT1-A standard documents
│   └── *.pdf
└── spec_others/      # Vendor device specifications
    └── *.pdf
```

Place PDF specifications in `spec_others/` before running:
```bash
spec-parser device onboard --pdf data/specs/spec_others/your_spec.pdf --vendor "Vendor" --model "Model"
```

---

## Citation Provenance

Every extracted element maintains full provenance:

```json
{
  "citation_id": "p12_txt5",
  "page": 12,
  "bbox": [392.23, 103.46, 442.64, 114.50],
  "source": "text",
  "content_type": "text"
}
```

| Field | Description |
|-------|-------------|
| `citation_id` | Unique ID: `p{page}_{type}{index}` |
| `page` | 1-indexed page number in source PDF |
| `bbox` | Bounding box `[x1, y1, x2, y2]` in PDF points |
| `source` | Extraction method: `"text"`, `"ocr"`, or `"graphics"` |
| `content_type` | Block type: `"text"`, `"table"`, or `"picture"` |

This enables:
- **Traceability:** Any extracted fact → exact PDF location
- **Auditability:** Human review can verify source
- **Reproducibility:** Re-extraction produces identical citations

---

## Workflow Summary

1. **Onboard:** `spec-parser device onboard --pdf <path>` → Creates session directory + updates global files
2. **Update:** `spec-parser device update --pdf <new.pdf>` → New session + CHANGE report + appends to registry
3. **Review:** `spec-parser device review-message` → Updates custom_messages.json status
4. **Search:** Use FAISS/BM25 indexes for semantic/keyword queries with citation links
